
// CRUD tests for UnitTypes using the autogenerated NocoDB client
const ApiClient = require('./../generated/generated-client'); // Adjust path as necessary
const assert = require('assert');
const { createApiClient } = require('../test-helpers');

async function unitTypeCrudTest() {
    const client = createApiClient();
    const api = new  ApiClient.UnitTypeApi(client); // Assuming UnitTypeApi exists

    let createdUnitTypeId = null;

    // Test Data
    const unitTypeName = `TestUnitType_${Date.now()}`;
    const updatedUnitTypeName = `UpdatedTestUnitType_${Date.now()}`;

    try {
        // 1. Create UnitType
        console.log(`   Attempting to create UnitType: ${unitTypeName}`);
        const createData = { name: unitTypeName }; // Adjust payload as per API definition
        const createdUnitType = await api.unitTypeCreate(createData);
        assert(createdUnitType, 'Create operation failed to return a result.');
        assert(createdUnitType.id, 'Created UnitType does not have an ID.');
        assert.strictEqual(createdUnitType.name, unitTypeName, `Expected name to be ${unitTypeName} but got ${createdUnitType.name}`);
        createdUnitTypeId = createdUnitType.id;
        console.log(`   ✅ UnitType created successfully with ID: ${createdUnitTypeId}`);

        // 2. Read UnitType (Get by ID)
        console.log(`   Attempting to read UnitType with ID: ${createdUnitTypeId}`);
        const fetchedUnitType = await api.unitTypeFindById(createdUnitTypeId);
        assert(fetchedUnitType, 'Read operation failed to return a result.');
        assert.strictEqual(fetchedUnitType.id, createdUnitTypeId, `Fetched UnitType ID ${fetchedUnitType.id} does not match created ID ${createdUnitTypeId}`);
        assert.strictEqual(fetchedUnitType.name, unitTypeName, `Fetched UnitType name ${fetchedUnitType.name} does not match original name ${unitTypeName}`);
        console.log(`   ✅ UnitType read successfully: ${fetchedUnitType.name}`);

        // 3. Update UnitType
        console.log(`   Attempting to update UnitType with ID: ${createdUnitTypeId} to name: ${updatedUnitTypeName}`);
        const updateData = { name: updatedUnitTypeName }; // Adjust payload as per API definition
        const updatedUnitType = await api.unitTypeUpdate(createdUnitTypeId, updateData);
        assert(updatedUnitType, 'Update operation failed to return a result.');
        assert.strictEqual(updatedUnitType.id, createdUnitTypeId, `Updated UnitType ID ${updatedUnitType.id} does not match created ID ${createdUnitTypeId}`);
        assert.strictEqual(updatedUnitType.name, updatedUnitTypeName, `Expected updated name to be ${updatedUnitTypeName} but got ${updatedUnitType.name}`);
        console.log(`   ✅ UnitType updated successfully to: ${updatedUnitType.name}`);

        // 4. List UnitTypes (verify creation and update)
        console.log(`   Attempting to list UnitTypes to verify changes`);
        const listResult = await api.unitTypeList(); // Add query params if needed, e.g., to filter by name
        assert(listResult && listResult.list, 'List operation failed or returned an unexpected structure.');
        const foundUpdated = listResult.list.some(ut => ut.id === createdUnitTypeId && ut.name === updatedUnitTypeName);
        assert(foundUpdated, `Updated UnitType (ID: ${createdUnitTypeId}, Name: ${updatedUnitTypeName}) not found in list.`);
        console.log(`   ✅ UnitType list verified.`);

    } catch (error) {
        console.error(`   ❌ Test step failed: ${error.message}`);
        if (error.response && error.response.body) {
            console.error('   API Error Response:', JSON.stringify(error.response.body, null, 2));
        }
        throw error; // Re-throw to fail the test
    } finally {
        // 5. Delete UnitType (Cleanup)
        if (createdUnitTypeId) {
            try {
                console.log(`   Attempting to delete UnitType with ID: ${createdUnitTypeId}`);
                await api.unitTypeDelete(createdUnitTypeId);
                console.log(`   ✅ UnitType deleted successfully: ${createdUnitTypeId}`);

                // Optionally, verify deletion by trying to fetch it again
                try {
                    await api.unitTypeFindById(createdUnitTypeId);
                    // If findById succeeds, it means deletion failed
                    assert.fail(`UnitType with ID ${createdUnitTypeId} was found after deletion attempt.`);
                } catch (errorAfterDelete) {
                    // Expect a 404 or similar error, depending on API behavior
                    // This confirms the deletion was successful
                    console.log(`   ✅ UnitType deletion confirmed (could not be found).`);
                }
            } catch (deleteError) {
                console.error(`   ❌ Cleanup failed: Could not delete UnitType with ID: ${createdUnitTypeId}. Error: ${deleteError.message}`);
                // Decide if this should fail the overall test or just be logged
            }
        }
    }
}

module.exports = unitTypeCrudTest;

